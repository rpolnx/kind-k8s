# Bitnami kafka

## Repo info

Chart repository [github](https://github.com/bitnami/charts/tree/master/bitnami/kafka)

Artifactory [artifacthub](https://artifacthub.io/packages/helm/bitnami/kafka)

- Chart Version: `14.0.1`

# Installation

## Initialize variables

```sh
  export BASE_CERT_PATH=./kafka/certs
  export NUMBER_OF_BROKERS=2
  export NS=tools
  export root_cert=ca.root.crt
  export root_key=ca.root.key
  export truststore_password=$(openssl rand -base64 20)
  export keystore_password=$(openssl rand -base64 20)
```

# Generate CA certs

```sh
  mkdir -p $BASE_CERT_PATH

  if [ ! -f "$BASE_CERT_PATH/$root_cert" ]; then
      echo "Create a root certificate"
      openssl req \
      -x509 \
      -days 1000 \
      -newkey rsa:2048 \
      -keyout $BASE_CERT_PATH/$root_key \
      -out $BASE_CERT_PATH/$root_cert \
      -subj "/C=SP/ST=Sao Paulo/L=Sao Paulo/O=Rpolnx/OU=Kafka SSL/CN=rpolnx.com.br" \
      -passin pass:$truststore_password \
      -passout pass:$truststore_password
  fi
```

## Generate client cert and key

```sh

  for i in producer consumer broker-0 broker-1 zookeeper
  do
    echo "Create a certificate for $i"
    ./kafka/create-jks-certificate.sh $i
    echo
  done

  echo "Create a truststore from openssl cert"

  keytool -delete -noprompt -trustcacerts -alias ca-truststore\
   -keystore $BASE_CERT_PATH/truststore.jks \
   -storepass $truststore_password \
   -keypass $truststore_password

  keytool -noprompt -keystore $BASE_CERT_PATH/truststore.jks \
  -alias ca-truststore -import -file $BASE_CERT_PATH/$root_cert \
  -storepass $truststore_password \
  -keypass $truststore_password


```

## (Optional) Cleaning unused files

```sh
  rm $BASE_CERT_PATH/*.srl
  rm $BASE_CERT_PATH/*.csr
```

## (Optional) Consumer and producer props

```sh
# Combine private key and cert in one file
echo
echo "Create consumer.properties with inline certificate, private key and truststore"
cat <<EOF > $BASE_CERT_PATH/consumer.properties
security.protocol=SSL
ssl.keystore.type=JKS
ssl.keystore.location=$BASE_CERT_PATH/consumer.keystore.jks
ssl.keystore.password=$keystore_password
ssl.key.password=$keystore_password
ssl.truststore.type=JKS
ssl.truststore.location=$BASE_CERT_PATH/truststore.jks
ssl.truststore.password=$truststore_password
EOF

echo
echo "Create producer.properties that uses JKS files"
cat <<EOF > $BASE_CERT_PATH/producer.properties
security.protocol=SSL
ssl.keystore.type=JKS
ssl.keystore.location=$BASE_CERT_PATH/producer.keystore.jks
ssl.key.password=$keystore_password
ssl.keystore.password=$keystore_password
ssl.truststore.type=JKS
ssl.truststore.location=$BASE_CERT_PATH/truststore.jks
ssl.truststore.password=$truststore_password
ssl.client.auth=required
security.inter.broker.protocol=SSL
EOF
```

## Secrets and configs

```sh
  ./kafka/create-secret-jks.sh
```

## Installing kafka chart

```sh
  helm repo add bitnami https://charts.bitnami.com/bitnami

  helm upgrade --install --version 14.0.1 -n $NS kafka-cluster bitnami/kafka \
  --values  "kafka/values.yaml" \
  --set     "heapOpts=-Xmx1024m -Xms1024m" \
  --set     "auth.clientProtocol=sasl" \
  --set     "auth.interBrokerProtocol=tls" \
  --set     "auth.tls.type=PEM" \
  --set     "auth.tls.existingSecret=kafka-secret" \
  --set     "auth.tls.jksTruststoreSecret=kafka-secret" \
  --set     "auth.tls.auth.tls.jksTruststore=kafka.truststore.jks" \
  --set     "auth.tls.jksKeystoreSAN=kafka.truststore.jks" \
  --set     "auth.tls.password=$(k get -n $NS secret kafka-secret -o=jsonpath='{.data.keystore-password}' | base64 -d)" \
  --set     "auth.tls.autoGenerated=true" \
  --set     "replicaCount=$NUMBER_OF_BROKERS" \
  --set     "externalAccess.enabled=true" \
  --set     "externalAccess.autoDiscovery.enabled=true" \
  --set     "externalAccess.service.port=9094" \
  --set     "externalAccess.service.type=LoadBalancer" \
  --set     "serviceAccount.create=true" \
  --set     "rbac.create=true" \
  --set     "persistence.size=3Gi" \
  --set     "provisioning.enabled=true" \
  --set     "provisioning.numPartitions=2" \
  --set     "provisioning.replicationFactor=2" \
  --set     "auth.sasl.jaas.clientUsers[0]=brokerUser" \
  --set     "auth.sasl.jaas.clientPasswords[0]=$(k get -n $NS secret kafka-secret -o=jsonpath='{.data.kafka-zookeper-password}' | base64 -d)" \
  --set     "auth.jaas.zookeeperUser=zookeeperUser" \
  --set     "auth.jaas.zookeeperPassword=$(k get -n $NS secret kafka-secret -o=jsonpath='{.data.kafka-zookeper-password}' | base64 -d)" \
  --set     "zookeeper.auth.enabled=true" \
  --set     "zookeeper.auth.clientUser=zookeeperUser" \
  --set     "zookeeper.auth.clientPassword=$(k get -n $NS secret kafka-secret -o=jsonpath='{.data.kafka-zookeper-password}' | base64 -d)" \
  --set     "zookeeper.auth.serverUsers=zookeeperUser" \
  --set     "zookeeper.auth.serverPasswords=$(k get -n $NS secret kafka-secret -o=jsonpath='{.data.kafka-zookeper-password}' | base64 -d)"

  #--set     "existingConfigmap=kafka-configmap-name" \
  #--set     "logPersistence.enabled=false" \
  #--set     "logPersistence.size=10Gi" \

```

# Testing

## Kafka client

```sh
    kubectl run kafka-cluster-client --restart='Never' --namespace $NS \
    --image docker.io/bitnami/kafka:2.8.0-debian-10-r76 --command -- sleep infinity

    kubectl cp --namespace $NS ./kafka/certs/client.properties kafka-cluster-client:/tmp/client.properties
    kubectl cp --namespace $NS ./kafka/certs/kafka-client.cert.jks kafka-cluster-client:/tmp/keystore.jks
    kubectl cp --namespace $NS ./kafka/certs/truststore.jks kafka-cluster-client:/tmp/ca.cert.jks

    kubectl exec --tty -i kafka-cluster-client --namespace $NS -- bash

```

## PRODUCER

```sh
  kafka-console-producer.sh \
      --producer.config /tmp/client.properties \
      --broker-list kafka-cluster-0.kafka-cluster-headless.tools.svc.cluster.local:9092,kafka-cluster-1.kafka-cluster-headless.tools.svc.cluster.local:9092,kafka-cluster-2.kafka-cluster-headless.tools.svc.cluster.local:9092 \
      --topic test
```

## CONSUMER

```sh
  kafka-console-consumer.sh \
      --consumer.config /tmp/client.properties \
      --bootstrap-server kafka-cluster.tools.svc.cluster.local:9092 \
      --topic test \
      --from-beginning
```
