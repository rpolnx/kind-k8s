# Bitnami mongo

## Repo info

Chart repository [github](https://artifacthub.io/packages/helm/bitnami/mongodb-sharded)

Artifactory [artifacthub](https://github.com/bitnami/charts/tree/master/bitnami/mongodb-sharded)

Mongo Sharding [docs](https://docs.mongodb.com/manual/sharding/)

- Chart Version: `10.27.3`

# Installation

## Namespace

```sh
NS=tools
```

## Secrets and configs

```sh
# Generate root password
MONGO_ROOT_PASSWORD=$(openssl rand -base64 20)

# Generate secret

kubectl -n $NS create secret generic mongo-rs-secret \
--from-literal "mongodb-root-password=$MONGO_ROOT_PASSWORD"

```

## Installing mongodb sharded chart

```sh

  helm repo add bitnami https://charts.bitnami.com/bitnami

  helm upgrade --install --version 10.27.3 -n $NS mongo-rs bitnami/mongodb \
  --values "./mongo-replica-set/values.yaml" \
  --set "architecture=standalone" \
  --set "auth.enabled=true" \
  --set "auth.rootUser=root" \
  --set "auth.rootPassword=$MONGO_ROOT_PASSWORD" \
  --set "tls.enabled=true" \
  --set "tls.autoGenerated=true" \
  --set "persistence.size=20Gi" \
  --set "service.type=LoadBalancer"
```

# Testing

** Please be patient while the chart is being deployed **

The MongoDB&reg; Sharded cluster can be accessed via the Mongos instances in port 27017 on the following DNS name from within your cluster:

`msc.$NS.svc.cluster.local`

To get the root password run:

```sh
    export MONGODB_ROOT_PASSWORD=$(kubectl get secret --namespace $NS mongo-secret \
     -o jsonpath="{.data.mongodb-root-password}" | base64 --decode)
```

To connect to your database run the following command:

```sh
    kubectl run --namespace $NS msc-client \
    --rm --tty -i --restart='Never' --image docker.io/bitnami/mongodb-sharded:4.4.8-debian-10-r9 \
    -command -- mongo admin --host msc
```

To connect to your database from outside the cluster execute the following commands:

NOTE: It may take a few minutes for the LoadBalancer IP to be available.
Watch the status with: 'kubectl get svc --namespace $NS -w msc'

```sh
    export SERVICE_IP=$(kubectl get svc --namespace $NS msc \
    --include "{{ range (index .status.loadBalancer.ingress 0) }}{{.}}{{ end }}")

    mongo --host $SERVICE_IP --port 27017 --authenticationDatabase admin -p $MONGODB_ROOT_PASSWORD
```
